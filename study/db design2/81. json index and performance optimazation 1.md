* json search performance
- json can be indexed
- virtual column index, multi-valued index

* json search performance issue
```sql
explain
select *
from product_json
where attributes->'$.storage' = 256;
```
+--+-----------+------------+----------+----+-------------+----+-------+----+----+--------+-----------+
|id|select_type|table       |partitions|type|possible_keys|key |key_len|ref |rows|filtered|Extra      |
+--+-----------+------------+----------+----+-------------+----+-------+----+----+--------+-----------+
|1 |SIMPLE     |product_json|null      |ALL |null         |null|null   |null|9   |100     |Using where|
+--+-----------+------------+----------+----+-------------+----+-------+----+----+--------+-----------+
- `type: ALL`: full table scan

* virtual column index
- since MySQL 5.7, json field can be indexed

1. virtual column creation
```sql
alter table product_json
add column v_storage int generated always as (attributes->>'$.storage') virtual;
```
- generated always as (expression): expression is evaluated
- virtual: it is not stored in a disk

```sql
select id, name, v_storage from product_json;
```

pros
1. storage saved: not stored in a disk
2. data integrity: v_storage is calculated

2. index creation to virtual column
```sql
create index idx_v_storage on product_json(v_storage);
```

3. performance improvement check
```sql
explain
select * from product_json where attributes->'$.storage' = 256;
```
+--+-----------+------------+----------+----+-------------+-------------+-------+-----+----+--------+-----+
|id|select_type|table       |partitions|type|possible_keys|key          |key_len|ref  |rows|filtered|Extra|
+--+-----------+------------+----------+----+-------------+-------------+-------+-----+----+--------+-----+
|1 |SIMPLE     |product_json|null      |ref |idx_v_storage|idx_v_storage|5      |const|1   |100     |null |
+--+-----------+------------+----------+----+-------------+-------------+-------+-----+----+--------+-----+
- `type: ref`: full table scan is replaced by index scan
- `key: idx_v_storage`: index is used

* virtual vs stored
- in MySQL, generated columns have two types of virtual and stored

virtual
```sql
alter table product_json
add column v_storage int generated always as (attributes->>'$.storage') virtual;
```
- virtual: default

stored
```sql
alter table product_json
add column s_storage int as (attributes->>'$.storage') stored;
```

1. difference between virtual and stored
whether the column is stored in a disk or not

virtual(default)
- only metadata is stored in a disk
- when select from the table, the column value is calculated
- when insert or update, the column value is not calculated
- storage saved
stored
- column value is stored in a disk
- when insert or update, the column value is calculated and stored in a disk
- when select from the table, the column value is read from a disk

2. in practice, why virtual is better?
- if virtual column is indexed, index is stored in a disk
- so, values are stored by b-tree structure in a disk
- so, stored is data duplication in a disk
  1. json original data is stored in a disk
  2. stored column value is stored in a disk(duplicate)
  3. index data is stored in a disk

3. when to use stored?
- column calculation is heavy
- normally, virtual is enough for JSON field indexing