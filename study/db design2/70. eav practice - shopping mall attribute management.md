setup
```sql
DROP TABLE IF EXISTS product_attribute;
DROP TABLE IF EXISTS product;
DROP TABLE IF EXISTS category;

-- 카테고리 테이블
CREATE TABLE category (
  category_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) NOT NULL,
  parent_id BIGINT,
  FOREIGN KEY (parent_id) REFERENCES category(category_id)
);

-- 상품 테이블 (Entity)
CREATE TABLE product (
  product_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  
  name VARCHAR(200) NOT NULL,
  price INT NOT NULL,
  status VARCHAR(20) DEFAULT 'ACTIVE',
  created_at DATETIME NOT NULL,
  
  category_id BIGINT NOT NULL,
  FOREIGN KEY (category_id) REFERENCES category(category_id)
);

-- 상품 속성 테이블 (Attribute-Value)
CREATE TABLE product_attribute (
  attribute_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  attr_name VARCHAR(100) NOT NULL,
  attr_value VARCHAR(500),
    
  created_at DATETIME NOT NULL,
    
  product_id BIGINT NOT NULL,
  FOREIGN KEY (product_id) REFERENCES product(product_id)
);

-- 인덱스 추가
CREATE INDEX idx_product_attribute_product ON product_attribute(product_id);
CREATE INDEX idx_product_attribute_name ON product_attribute(attr_name);
```
- a product table includes common attributes

insert product of variable category

```sql
-- 카테고리 입력
INSERT INTO category (category_id, name, parent_id) VALUES
(1, '전자제품', NULL),
(2, '스마트폰', 1),
(3, '노트북', 1),
(4, '의류', NULL),
(5, '상의', 4),
(6, '식품', NULL);

-- 상품 입력
INSERT INTO product (product_id, category_id, name, price, created_at) VALUES
(1, 2, 'Galaxy S24 Ultra', 1650000, NOW()),
(2, 2, 'iPhone 15 Pro', 1550000, NOW()),
(3, 3, 'MacBook Pro 14', 2690000, NOW()),
(4, 5, '캐시미어 니트', 89000, NOW());

-- 스마트폰 속성 (Galaxy S24 Ultra)
INSERT INTO product_attribute (product_id, attr_name, attr_value, created_at) VALUES
(1, 'screen_size', '6.8인치', NOW()),
(1, 'battery_capacity', '5000mAh', NOW()),
(1, 'ram', '12GB', NOW()),
(1, 'storage', '256GB', NOW()),
(1, 'main_camera', '200MP', NOW()),
(1, 'processor', 'Snapdragon 8 Gen 3', NOW()),
(1, 's_pen', 'Y', NOW()),
(1, 'color', '티타늄 바이올렛', NOW());

-- 스마트폰 속성 (iPhone 15 Pro)
INSERT INTO product_attribute (product_id, attr_name, attr_value, created_at) VALUES
(2, 'screen_size', '6.1인치', NOW()),
(2, 'battery_capacity', '3274mAh', NOW()),
(2, 'ram', '8GB', NOW()),
(2, 'storage', '256GB', NOW()),
(2, 'main_camera', '48MP', NOW()),
(2, 'processor', 'A17 Pro', NOW()),
(2, 'action_button', 'Y', NOW()),
(2, 'color', '블루 티타늄', NOW());

-- 노트북 속성 (MacBook Pro 14)
INSERT INTO product_attribute (product_id, attr_name, attr_value, created_at) VALUES
(3, 'screen_size', '14.2인치', NOW()),
(3, 'processor', 'M3 Pro', NOW()),
(3, 'ram', '18GB', NOW()),
(3, 'storage', '512GB SSD', NOW()),
(3, 'battery_life', '17시간', NOW()),
(3, 'weight', '1.61kg', NOW()),
(3, 'ports', 'HDMI, SD카드, MagSafe, Thunderbolt x3', NOW());

-- 의류 속성 (캐시미어 니트)
INSERT INTO product_attribute (product_id, attr_name, attr_value, created_at) VALUES
(4, 'material', '캐시미어 100%', NOW()),
(4, 'size', 'S, M, L, XL', NOW()),
(4, 'color', '아이보리, 네이비, 그레이', NOW()),
(4, 'origin', '이탈리아', NOW()),
(4, 'washing', '드라이클리닝', NOW()),
(4, 'season', 'F/W', NOW());
```

* eav query

query to all attributes of specific product 
```sql
SELECT
  p.product_id,
  p.name AS product_name,
  p.price,
  pa.attr_name,
  pa.attr_value
FROM product p
JOIN product_attribute pa ON p.product_id = pa.product_id
WHERE p.product_id = 1
ORDER BY pa.attr_name;
```
+----------+----------------+-------+----------------+------------------+
|product_id|product_name    |price  |attr_name       |attr_value        |
+----------+----------------+-------+----------------+------------------+
|1         |Galaxy S24 Ultra|1650000|battery_capacity|5000mAh           |
|1         |Galaxy S24 Ultra|1650000|color           |티타늄 바이올렛          |
|1         |Galaxy S24 Ultra|1650000|main_camera     |200MP             |
|1         |Galaxy S24 Ultra|1650000|processor       |Snapdragon 8 Gen 3|
|1         |Galaxy S24 Ultra|1650000|ram             |12GB              |
|1         |Galaxy S24 Ultra|1650000|s_pen           |Y                 |
|1         |Galaxy S24 Ultra|1650000|screen_size     |6.8인치             |
|1         |Galaxy S24 Ultra|1650000|storage         |256GB             |
+----------+----------------+-------+----------------+------------------+

query to product by specific attribute
```sql
SELECT
  p.product_id,
  p.name,
  p.price,
  pa.attr_value AS ram
FROM product p
JOIN product_attribute pa ON p.product_id = pa.product_id
WHERE pa.attr_name = 'ram'
 AND pa.attr_value = '12GB';
```
+----------+----------------+-------+----+
|product_id|name            |price  |ram |
+----------+----------------+-------+----+
|1         |Galaxy S24 Ultra|1650000|12GB|
+----------+----------------+-------+----+

query to product by multiple attributes
```sql
SELECT p.product_id, p.name, p.price
FROM product p
WHERE p.product_id IN (
  SELECT product_id
  FROM product_attribute
  WHERE attr_name = 'screen_size'
   AND attr_value LIKE '6%'
)
AND p.product_id IN (
  SELECT product_id
  FROM product_attribute
  WHERE attr_name = 's_pen'
   AND attr_value = 'Y'
);
```
+----------+----------------+-------+
|product_id|name            |price  |
+----------+----------------+-------+
|1         |Galaxy S24 Ultra|1650000|
+----------+----------------+-------+

pivot: transform row to column

query to smartphone product like table structure
```sql
SELECT
  p.product_id,
  p.name,
  p.price,
  MAX(CASE WHEN pa.attr_name = 'screen_size' THEN pa.attr_value END) AS screen_size,
  MAX(CASE WHEN pa.attr_name = 'battery_capacity' THEN pa.attr_value END) AS battery,
  MAX(CASE WHEN pa.attr_name = 'ram' THEN pa.attr_value END) AS ram,
  MAX(CASE WHEN pa.attr_name = 'storage' THEN pa.attr_value END) AS storage
FROM product p
LEFT JOIN product_attribute pa ON p.product_id = pa.product_id
WHERE p.category_id = 2 -- 스마트폰 카테고리
GROUP BY p.product_id, p.name, p.price;
```
+----------+----------------+-------+-----------+-------+----+-------+
|product_id|name            |price  |screen_size|battery|ram |storage|
+----------+----------------+-------+-----------+-------+----+-------+
|1         |Galaxy S24 Ultra|1650000|6.8인치      |5000mAh|12GB|256GB  |
|2         |iPhone 15 Pro   |1550000|6.1인치      |3274mAh|8GB |256GB  |
+----------+----------------+-------+-----------+-------+----+-------+

* practice: dynamic adding attribute

add new attribute to galaxy s24 ultra
```sql
-- 새로운 속성 추가
INSERT INTO product_attribute (product_id, attr_name, attr_value, created_at) VALUES
(1, 'water_resistance', 'IP68', NOW()),
(1, 'wireless_charging', 'Y', NOW()),
(1, 'reverse_charging', 'Y', NOW()),
(1, '5g_support', 'Y', NOW());

-- 확인
SELECT attr_name, attr_value
FROM product_attribute
WHERE product_id = 1
ORDER BY created_at DESC
LIMIT 5;
```