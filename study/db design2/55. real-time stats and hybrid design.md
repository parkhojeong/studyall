* requirement: today now point-in-time sales. real-time dashboard

1. daily_sales_stats is inserted after the day end
2. using orders with `group by` can make performance issue

hybrid query design
1. past data: use daily_sales_stats
2. today data: aggregate from orders
- to avoid a full table scan, order_date must be indexed
3. union: past + today

* practice: hybrid query
- requirement
  - current time: 2026-01-04 12:00:00
  - today stats does not exist yet
  - get stats 2026-01-01 ~ 2026-01-04 

data setup
```sql
-- 1. 테이블 초기화 (기존 테이블 삭제 후 재생성)
DROP TABLE IF EXISTS daily_sales_stats;
DROP TABLE IF EXISTS orders;

-- 통계 테이블 생성
CREATE TABLE daily_sales_stats (
  stat_date DATE NOT NULL,
  total_order_count INT NOT NULL DEFAULT 0,
  total_sales_amount BIGINT NOT NULL DEFAULT 0,
  PRIMARY KEY (stat_date)
);

-- 주문 테이블 생성
CREATE TABLE orders (
  order_id BIGINT AUTO_INCREMENT PRIMARY KEY,
  customer_id BIGINT NOT NULL,
  total_amount INT NOT NULL,
  order_status VARCHAR(20) NOT NULL,
  order_date DATETIME NOT NULL
);

CREATE INDEX idx_orders_order_date ON orders (order_date);

-- 2. 과거 데이터 입력 (통계 테이블)
-- 1월 1일 ~ 1월 3일 데이터는 이미 배치가 돌아서 통계 테이블에 요약되어 있다고 가정한다.
INSERT INTO daily_sales_stats (stat_date, total_order_count, total_sales_amount) VALUES
('2026-01-01', 3, 50000),
('2026-01-02', 2, 80000),
('2026-01-03', 1, 45000);

-- 3. 오늘 실시간 데이터 입력 (주문 테이블)
-- 1월 4일(오늘) 주문은 아직 배치가 돌지 않았으므로 원본 orders 테이블에만 존재한다.
INSERT INTO orders (customer_id, total_amount, order_status, order_date) VALUES
(10, 60000, 'COMPLETED', '2026-01-04 10:00:00'), -- 오늘 오전 주문 1
(11, 20000, 'COMPLETED', '2026-01-04 11:30:00'); -- 오늘 오전 주문 2
```

hybrid query
```sql
select 
    stat_date,
    total_order_count,
    total_sales_amount
from daily_sales_stats 
where stat_date >= '2026-01-01' and stat_date < '2026-01-04'

union all

select
    date(order_date),
    count(*),
    sum(total_amount)
from orders
where order_date >= '2026-01-04 00:00:00' and order_status = 'COMPLETED'
group by date(order_date);
```

- monthly stats by hybrid query
requirement: 2026-01 monthly stats
```sql
select 
    date_format(stats.stat_date, '%Y-%m') as stat_month, 
    count(*) as monthly_order_count, 
    sum(total_sales_amount) as monthly_sales_amount
from (
select 
    stat_date,
    total_order_count,
    total_sales_amount
from daily_sales_stats
where stat_date >= '2026-01-01' and stat_date < '2026-01-04'

union all

select 
    date(order_date) as stat_date,
    count(*) as total_order_count,
    sum(total_amount) as total_sales_amount
from orders
where order_date >= '2026-01-04 00:00:00' and order_status = 'COMPLETED'
group by date(order_date)
) as stats
group by date_format(stats.stat_date, '%Y-%m');
```
| stat_month | monthly_order_count | monthly_sales_amount |
|:-----------|:--------------------|:---------------------|
| 2026-01    | 4                   | 255000               |


insight
- from a stat table, calculated rows are read
- from an order table, by order_date index, small data is read quickly