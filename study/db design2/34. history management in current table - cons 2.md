* cons: statistics performance issue and complex query
requirement: at 2026-03-10, all product total stock quantity

approach1: sub query
```sql
select sum(p1.stock_quantity)
from product p1
where created_at in (
    select max(created_at) 
    from product p2
    where created_at < '2026-03-11 00:00:00'
    and p2.product_id=p1.product_id
    order by created_at desc
)
```

approach2: join
```sql
select sum(p1.stock_quantity)
from product p1
join (
    select product_id, max(created_at) as max_created_at
    from product
    where created_at < '2026-03-11 00:00:00'
    group by product_id
) as p2 on p1.created_at=max_created_at and p1.product_id=p2.product_id
```

# split into steps

* step1: filter by specific data
```sql
select history_id, product_id, created_at
from product
where created_at < '2026-03-11 00:00:00'
order by created_at desc;
```
| history_id | product_id | created_at          |
|:-----------|:-----------|:--------------------|
| 3          | 1          | 2026-03-01 10:00:00 |
| 2          | 2          | 2026-01-15 10:05:00 |
| 1          | 1          | 2026-01-15 10:00:00 |


* step2: last created_at by product_id
```sql
select product_id, max(created_at) as max_created_at
from product
where created_at < '2026-03-11 00:00:00'
group by product_id;
```
| product_id | max_created_at      |
|:-----------|:--------------------|
| 1          | 2026-03-01 10:00:00 |
| 2          | 2026-01-15 10:05:00 |

* step3: join with original table
```sql
select p.product_id, p.name, p.stock_quantity, p.created_at
from product p 
join (
    select product_id, max(created_at) as max_created_at
    from product
    where created_at < '2026-03-11 00:00:00'
    group by product_id
) latest on p.product_id=latest.product_id 
        and p.created_at=latest.max_created_at
```

* step4: final aggregation
```sql
explain select sum(p.stock_quantity) as total_stock
from product p 
join (
    select product_id, max(created_at) as max_created_at
    from product
    where created_at < '2026-03-11 00:00:00'
    group by product_id
) latest on p.product_id=latest.product_id 
        and p.created_at=latest.max_created_at
```

3 problems
1. query at a specific time and aggregation 
   - complex
   - performance issue
2. a single table has too many rows