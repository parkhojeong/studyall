# denormalization - duplicated column addition
```sql
select
    oi.order_id,
    p.product_name, -- join is required
    oi.order_price,
    oi.order_quantity
from order_items oi
join products p on oi.product_id = p.product_id
where oi.order_id = 100
```
in an order_item table, add a column for the product name
1. product_name column addition in order_item table
```sql
alter table order_items add column product_name varchar(255);
```
```sql
select
    oi.order_id,
    oi.product_name, -- join is omitted
    oi.order_price,
    oi.order_quantity
from order_items oi
where oi.order_id = 100
```
2. data storage process changes
- when order_item is inserted, the product name is also inserted

caution: but it can be snapshot data, not denormalization


# denormalization - additional column addition
```sql
select
    o.order_id,
    o.ordered_at,
    sum(oi.order_price * oi.order_quantity) as total_amount -- calculation is required
from orders o
join order_items oi on o.order_id = oi.order_id
where o.order_id = 100
group by o.order_id
```
- add total_amount
```sql
alter table orders add column total_amount int;
```

after query
```sql
select 
    o.order_id,
    o.ordered_at,
    o.total_amount -- calculation is omitted
from orders o
where o.order_id = 100
```



# denormalization - table combination
- orders-delivery is always 1:1, how to combine them?
- delivery(ship_address, delivery_status, tracking_no)

- order-delivery combination could be not good idea
1. two tables have different data lifecycle
- orders: when user orders, orders is created. ordered product and price is fixed
- delivery: after user orders, delivery is created. delivery status and tracking number is updated
- if two tables are combined, columns(tracking_no) related to delivery start with null

2. data update frequency is different
- orders: snapshot data is rarely updated
- delivery: frequently updated
- if two tables are combined, a table is updated frequently by delivery update
  - it increases lock race condition potential

3. table responsibility and cohesion are broken(srp violation)
- orders: when, who, what user ordered
- delivery: how, where, what status delivered
- if two tables are combined, two responsibilities are mixed

4. scalability decrease seriously
- orders-delivery is a 1:1 relationship, but how service scales?
- if bundled delivery or split delivery are required, orders-delivery relationship have to be changed 1:n
  - if two tables are combined, it is hard to change

5. optional relationship handling
- what if our shopping mall sells without a delivery?
- if delivery is optional, the combined table has null columns related to delivery
  - it is hard to distinguish delivery_status=NULL is 'no delivery' or 'before start delivery'
6. the performance difference is not huge
- orders-delivery join is based on pk-fk key join. it is fast enough

* conclusion: separate orders-delivery is better
- clarity, flexibility, scalability is kept


* practice guide
1. if the lifecycle is different, separate tables
2. if updated frequency is different, separate tables